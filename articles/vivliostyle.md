# Vivliostyle使ってみた

本書の内容自体は手堅くハズれがなくライブラリ規模もさほど大きくないものにしたので、反動で別のところで冒険する気持ちになりました。
今回は普段使っているRe:VIEWを離れ、Vivliostyleを試してみることにしました。
運営タスクで忙殺されることがわかってるはずなのになぜ毎回こういう冒険をしてしまうのか…？

筆者は長年TechBoosterのReVIEW-Template<span class="footnote">https://github.com/TechBooster/ReVIEW-Template</span>を使っていて、これに特に大きな不満があるわけではありません。
よって、だいぶRe:VIEWでの体験に毒されているというか、Re:VIEWにあるものがないと難色を示しがち…というバイアスがあることは先に断っておきます。
郷に入っては郷に従えと言いますし、VivliostyleではVivliostyleなりのやり方があります（けど、ついRe:VIEWに肩入れしてしまう）。

というわけで、この章ではVivliostyleを使い始めるにあたり辿った道筋をここに記しておきます。

とりあえずプロジェクト作成。

```shell
$ yarn create book tbf14-slog-book
...
? Description description
? Author name vvakame
? Author email vvakame@gmail.com
? License MIT
? choose theme @vivliostyle/theme-techbook
     - Techbook (技術同人誌) theme
...
```

作成されたファイルの内容は、うーん、だいぶ質素…。
GitHub Actionsでのビルドワークフローがないのはもちろん、ファイルも最低限の構成で、あとは本文を書くだけ！という状態ではない。
テーマを自分で作れるし、実際に配布している人もいるようだけど、デファクトと呼べるレベルのものはまだなさそう。

PDFをビルドしてみたけど、物理本をターゲットにしたスタイリングになっている。
小口とノドの幅にかなり差があり、電子機器でPDFを読む時、本文がページをめくるたびに左右にガチャガチャしてしまう。
この辺はどこで設定変えられるんだろうな？

ついでに、epubを生成する方法も今のところわかってない。

本を作るためのガイドを探したところ、次の2つのページを見つけたので読んだ。

* https://docs.vivliostyle.org/#/ja/create-book
* https://vivliostyle.org/ja/make-books-with-create-book/

まずは自分の今までの本がどうなっているかを知るため、技術書典NFT<span class="footnote">https://techbookfest.org/product/9GsUCh18KNL40JTqr4savb</span>のPDFを眺めてみる。
こいつはいつもどおりのTechBoosterのReVIEW-Template製なので、こいつの見た目に近くなると僕が感じる違和感は減りそう。
いつものがいいならいつものでいいじゃん、という内なる声が聞こえる…。
だがしかしいつものやつに居続けてはイノベーションなどないのだ、と克己していく。
うーん、やっぱりノドと小口がほぼ同じだなぁ。

というわけで、Vivliostyleでもなにか先達がいないかと思って「Vivliostyle ノド 小口」で検索すると良い記事<span class="footnote">https://zenn.dev/macneko/articles/06aec138a357b9</span>が見つかった。
ええやんこれで！！記事の最後とかでテーマ配布します！とか言い始めたら最高！と思いつつ読み勧めたけどそういうものはなかった。
残念無念。

とはいえ書かれている内容に従ってテーマをカスタマイズしていったら、わりとお望み通りの見た目になった。
嬉しいので記事にガッツリ投げ銭しておきました。

あとは、脚注に色々書いたりURLを逃したりすることが多いので脚注のやり方を調べる。
VFM（Vivliostyle Flavored Markup）では専用の記法があるっぽい。
いったんページ下部に脚注が出るようになった。

あ、あと表紙はどうするのかな。
Re:VIEWだと表紙画像をPDFの先頭に入れてくれる的なオプションがあったけども。
VivliostyleのIssueに、表紙オプションのサポート<span class="footnote">https://github.com/vivliostyle/vivliostyle-cli/issues/99</span>というのがあった。
うーんなるほど、今のところは自分で気合でやらないといけないっぽい。
僕の場合、販売用書籍は表紙あり、全文公開の時は表紙なしというビルドにしているので、リポジトリ内には表紙データを入れないんですよね…。
この辺ちょっとめんどくさいな。
とりあえず気合でcover.htmlを作成して解決。
プレビュー時に画像がないので壊れた画像マークが出るのがダサい。
`vivliostyle.config.js` のentryでcover.htmlをコメントアウトすると自動生成の表紙が挿入されこれも見栄えが悪い。
仕方がないので、ダミーの表紙画像と表紙HTMLを同梱しておくのがいいのかも。
面倒なのでこれは後回し。

結局、epubの出し方は存在してなさそう。
webpubというフォーマットで出力できるようだけど、これは果たして一般的なリーダーでサポートされているものなのかしら？
謎である。

わりと困ることが色々あるのだけど、Twitterにツイートすると色々教えてくださるリプライがくる。
たとえば https://twitter.com/hid_alma1026/status/1647559375744278529 とか https://twitter.com/MurakamiShinyu/status/1647771227258507265 とかです。
僕は結構前からGitHubのスポンサー機能でVivliostyleのスポンサーを少額ながらしている<span class="footnote">と言いつつ、2023年2月にPayPalによる支払いが停止されたのに気が付かず3ヶ月ほど穴が空いててさっき慌てて再設定した</span>のですが、コミュニティイベントへの参加のお誘いやレポートなどをくださることがあり、全体的に高い熱意が維持され続けています。
各位ありがとうございます。
唐突な番宣でした（？）。

さて、次は目次（Table of Content）の出力。
これもどうやるのかよくわからず、調べてみたら章・節・項でいうと章タイトルだけの目次しか生成できないらしい。
村上さんがツイートで教えてくださった目次の生成方法を見たらPythonのスクリプトで自前生成していた。
しかたがないので自分もNode.jsでmarkdownを雑にテキスト処理してtocを出力するスクリプトを書いた。

ところが、Vivliostyleに生成させたtoc.htmlをレンダリングさせてみると、ページ数が `??` になってしまい、数字に置き換わらない。
なんでかなと思ったら、VFMを変換して作成されるHTMLでは、idが英数小文字に変換されていたので、 `toLowerCase` した値をidに指定しないと一致しないのであった。
ここを直したらちゃんとページ数が表示されるようになった。
よかった。

あとの課題は、toc.htmlを出力するのが若干面倒なところ。
Markdownから部分的に生成したHTMLをどこかのHTMLファイルのbodyに埋め込むみたいなことが簡単にできない。
`handlebars` 的なテンプレートエンジンを導入するのもtoo muchだしなー。
どうしよかな。
今はいったん保留。

次の課題はサンプルコードを本文中に埋め込む方法について。
Re:VIEW時代はreview-preproc<span class="footnote">https://github.com/kmuto/review/blob/master/doc/preproc.ja.md</span>というプリプロセッサがあって、Re:VIEWファイル中のテキストをコマンド1つで別のファイルの内容で置き換えられた。
しかしVivliostyleではそれがないので、なんとかしないといけない。
色々考えた結果、仕方がないのでツールを自作することにした。
ptproc<span class="footnote">https://github.com/vvakame/ptproc</span>（Plain Text PROCessor）というツールを作った。
次のような感じでサンプルコードを本文中に展開できる。

<pre>
&lt;!-- mapfile:./exp.version.txt --&gt;
```
v0.0.0-20230510235704-dd950f8aeaea
```
&lt;!-- mapfile.end --&gt;
</pre>

これを作るのに5日くらいかかり、ゴールデンウィークの前半が溶けた。
かなしい…。
執筆全然進んでない…。

執筆を進めて、ページ数が増えていくと、脚注が章の末尾にくるのに気がついた。
前試したときはページ数がそもそも少なかったので、脚注が同じページ…というか、2ページ目の先頭に出ていたので、CSSの書き方が悪いんだろうな…と思っていたんだけど、どうやら仕様らしい。

調べてみると、脚注と後注という概念があり、VFMの脚注は後注のことらしい。
不勉強ながら後注という概念を知らなかったので調べてみた。
調べると、脚注（footnote）はページ末に入れるもので、後注は（endnote）は章末などに入れるもの、と説明しているページが多かった。
今まで知らなかったけど、Re:VIEWもendnoteという記法があった。
そうだったんだなぁ。

VFMはPandocのfootnoteの記法を持ってきている。
なので、footnoteと言ってるけど現実はendnoteのことだったようだ。
これは僕の推測だが、PandocはPaged Mediaを記述するための記法ではないので、footnoteとendnoteの区別がなくてこうなってるんじゃなかろうか。

この本は `@vivliostyle/theme-techbook` をベースにしているので、 `<span class="footnote">これ脚注</span>` と書けるCSSが入っているらしい。

うーん、slogについての本文は9割書き上がっていて、今からVFMのfootnote記法をHTMLを使った記法に置き換えていくのは心底めんどくさい…。
VivliostyleはCSS組版なので、CSSの事情が原稿側に漏れ出さざるをえなくなることが度々ありそう。
そう考えると、原稿をHTMLに変換するフェーズで任意の処理を差し込めるメリットが大きい。
と考えると拡張が難しいマークダウンじゃなくてマークアップな何かで原稿を書いたほうがいいんじゃないの…という気持ちになる。
そう考えるとRe:VIEW記法はわりと理にかなっている…。
アレはアレでパーサとプロセッサが一体化していてすごい苦しいところはあるんだけども…。

あとは、図1.1とか表1.1みたいな自動採番と文中からの参照がないのも少し困ってしまう。
Vivliostyle的にはそれができると記憶しているが、VFMでそれを表現する能力がないため（のはず？）だ。
これがないと本文のテイストが微妙にブログっぽくなってしまう感じがある。
まぁ今の所あまり困ってはいない（けど欲しい）。

5月12日にリブロワークスさんの `Web技術で本が作れる CSS組版Vivliostyle入門` <span class="footnote">https://vivliostyle.org/ja/blog/2023/05/10/vivliostyle-book/</span>という本が出ました。
届いてからまだ10分くらいしか眺めていないのですが、先に書いた脚注後注の話と脚注を実現するためのcssの書き方なども記載されていました。
全編ちゃんと読むとだいぶいい感じにできそうな感じがします。
今これを書いているのは5月14日（日）22時過ぎであり、技術書典14は20日からなのでもう日がないため、完成度より完成のほうが重要だろ！となってしまっているので本書には反映できなさそうなのは残念なところです。

それはそれとして、Vivliostyleを使ってここまで書いた+ツールも作ったので、この本は技術書典14の会期が終わったあたりで https://github.com/vvakame/tbf14-slog-book で全文公開しようと思います。
この本の記法やビルドプロセスが気になる人はチェックしてみてください。

もし次回本を作るとしたら、Vivliostyleは使う、VFMじゃない記法を試す、細かな改善はすすめる、という感じを目指したいかなぁ…。
マークアップで書けて、JavaScriptかLua（書いたことないけど）あたりの記法で拡張できるHTMLトランスレータがあるものがいいんだけど、なんかないかな。
Re:VIEW記法で書いて泣きながらRubyで拡張する、というパターンになりそうな気はする。

ともあれ、本文が全部かけたので技術書典Webサイト上で書籍情報を登録した。
あとはセルフレビューと誰かにレビュー頼むのと、footnoteどうしようかなぁ…。
後注だと読みづらいので仕方ないので直すか…。
